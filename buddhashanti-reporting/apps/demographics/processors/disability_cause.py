"""
Disability Cause Demographics Processor

Handles disability cause demographic data processing, chart generation, and report formatting.
"""

import subprocess
from pathlib import Path
from .base import BaseDemographicsProcessor, BaseReportFormatter
from ..models import WardWiseDisabilityCause, DisabilityCauseChoice
from ..utils.svg_chart_generator import DEFAULT_COLORS
from apps.reports.utils.nepali_numbers import (
    format_nepali_number,
    format_nepali_percentage,
)
from apps.chart_management.processors import SimpleChartProcessor


class DisabilityCauseProcessor(BaseDemographicsProcessor, SimpleChartProcessor):
    """Processor for disability cause demographics"""

    def __init__(self):
        super().__init__()
        SimpleChartProcessor.__init__(self)

        # Ensure we use the same directory as the chart service
        from django.conf import settings

        if hasattr(settings, "STATICFILES_DIRS") and settings.STATICFILES_DIRS:
            # Use same directory as chart management service
            self.static_charts_dir = (
                Path(settings.STATICFILES_DIRS[0]) / "images" / "charts"
            )
        else:
            # Fallback to STATIC_ROOT
            self.static_charts_dir = Path(settings.STATIC_ROOT) / "images" / "charts"

        self.static_charts_dir.mkdir(parents=True, exist_ok=True)

        # Customize chart dimensions for disability cause
        self.pie_chart_width = 900
        self.pie_chart_height = 450
        self.bar_chart_width = 1000
        self.bar_chart_height = 600
        self.chart_radius = 130
        # Set disability cause-specific colors
        self.chart_generator.colors = {
            "CONGENITAL": "#FF6B6B",  # Red
            "ACCIDENT": "#4ECDC4",  # Teal
            "DISEASE": "#45B7D1",  # Blue
            "MALNUTRITION": "#96CEB4",  # Green
            "CONFLICT": "#FFEAA7",  # Yellow
            "OTHER": "#DDA0DD",  # Plum
        }

    def get_chart_key(self):
        """Return unique chart key for this processor"""
        return "demographics_disability_cause"

    def get_section_title(self):
        return "‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ‡§ï‡§æ ‡§Ü‡§ß‡§æ‡§∞‡§Æ‡§æ ‡§ú‡§®‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£"

    def get_section_number(self):
        return "‡•©.‡•ß‡•¶"

    def get_data(self):
        """Get disability cause population data - both municipality-wide and ward-wise"""
        # Municipality-wide summary
        disability_data = {}

        # Initialize all disability causes
        disability_types = {
            "CONGENITAL": "‡§ú‡§®‡•ç‡§Æ‡§ú‡§æ‡§§",
            "ACCIDENT": "‡§¶‡•Å‡§∞‡•ç‡§ò‡§ü‡§®‡§æ",
            "DISEASE": "‡§∞‡•ã‡§ó‡§ï‡•ã ‡§ï‡§æ‡§∞‡§£",
            "MALNUTRITION": "‡§ï‡•Å‡§™‡•ã‡§∑‡§£",
            "CONFLICT": "‡§¶‡•ç‡§µ‡§®‡•ç‡§¶‡•ç‡§µ‡§ï‡•ã ‡§ï‡§æ‡§∞‡§£",
            "OTHER": "‡§Ö‡§®‡•ç‡§Ø",
        }

        for dis_code, dis_name in disability_types.items():
            disability_data[dis_code] = {
                "population": 0,
                "percentage": 0.0,
                "name_nepali": dis_name,
            }

        # Ward-wise data for bar chart and detailed table
        ward_data = {}
        for ward_num in range(1, 9):  # Wards 1-8
            ward_data[ward_num] = {
                "ward_name": f"‡§µ‡§°‡§æ ‡§®‡§Ç. {ward_num}",
                "demographics": {},
            }
            # Initialize disability causes for each ward
            for dis_code, dis_name in disability_types.items():
                ward_data[ward_num]["demographics"][dis_code] = {
                    "population": 0,
                    "name_nepali": dis_name,
                }

        # Get actual data from database
        total_population = 0
        try:
            for disability_obj in WardWiseDisabilityCause.objects.all():
                disability = disability_obj.disability_cause.upper()
                if disability == "UNKNOWN":
                    disability = "OTHER"
                ward_num = disability_obj.ward_number
                population = disability_obj.population

                # Add to municipality-wide totals
                if disability in disability_data:
                    disability_data[disability]["population"] += population
                    total_population += population

                # Add to ward-wise data
                if (
                    ward_num in ward_data
                    and disability in ward_data[ward_num]["demographics"]
                ):
                    ward_data[ward_num]["demographics"][disability][
                        "population"
                    ] += population
        except Exception as e:
            print(f"Error fetching disability cause data: {e}")
            # Return empty data structure if database error
            return {
                "municipality_data": disability_data,
                "ward_data": ward_data,
                "total_population": 0,
            }

        # Calculate percentages for municipality-wide data
        if total_population > 0:
            for disability, data in disability_data.items():
                data["percentage"] = (data["population"] / total_population) * 100

        # Calculate ward totals and percentages
        for ward_num, ward_info in ward_data.items():
            ward_total = sum(
                demo["population"] for demo in ward_info["demographics"].values()
            )
            ward_info["total_population"] = ward_total

            # Calculate percentages within each ward
            if ward_total > 0:
                for disability, demo in ward_info["demographics"].items():
                    demo["percentage"] = (
                        (demo["population"] / ward_total) * 100 if ward_total > 0 else 0
                    )

        return {
            "municipality_data": disability_data,
            "ward_data": ward_data,
            "total_population": total_population,
        }

    def generate_report_content(self, data):
        """Generate disability cause-specific report content"""
        formatter = self.DisabilityCauseReportFormatter()
        return formatter.generate_formal_report(
            data["municipality_data"], data["ward_data"], data["total_population"]
        )

    def generate_chart_svg(self, data, chart_type="pie"):
        """Generate disability cause chart SVG using SVGChartGenerator"""
        if chart_type == "pie":
            return self.chart_generator.generate_pie_chart_svg(
                data["municipality_data"],
                include_title=False,
                title_nepali="‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ‡§ï‡§æ ‡§ï‡§æ‡§∞‡§£ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§ú‡§®‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§µ‡§ø‡§§‡§∞‡§£",
                title_english="Population Distribution by Disability Cause",
            )
        elif chart_type == "bar":
            return self.chart_generator.generate_bar_chart_svg(
                data["ward_data"],
                include_title=False,
                title_nepali="‡§µ‡§°‡§æ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ‡§ï‡§æ ‡§ï‡§æ‡§∞‡§£ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§ú‡§®‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§µ‡§ø‡§§‡§∞‡§£",
                title_english="Disability Cause Distribution by Ward",
            )
        return None

    def generate_and_track_charts(self, data):
        """Generate charts only if they don't exist and track them using simplified chart management"""
        charts = {}

        # Ensure static charts directory exists
        self.static_charts_dir.mkdir(parents=True, exist_ok=True)

        # Check and generate pie chart only if needed
        if self.needs_generation("pie"):
            print(f"üîÑ Generating disability cause pie chart...")
            success, png_path, svg_path = self.chart_generator.generate_chart_image(
                demographic_data=data.get("municipality_data", {}),
                output_name="disability_cause_pie_chart",
                static_dir=str(self.static_charts_dir),
                chart_type="pie",
                include_title=False,
            )

            if success and png_path:
                charts["pie_chart_png"] = f"images/charts/{Path(png_path).name}"
                charts["pie_chart_url"] = f"images/charts/{Path(png_path).name}"
                self.mark_generated("pie")
                print(
                    f"‚úÖ Disability cause pie chart generated successfully: {png_path}"
                )
            elif svg_path:
                charts["pie_chart_svg"] = f"images/charts/{Path(svg_path).name}"
                charts["pie_chart_url"] = f"images/charts/{Path(svg_path).name}"
                self.mark_generated("pie")
                print(f"‚úÖ Disability cause pie chart SVG generated: {svg_path}")
        else:
            # Chart already exists, get the URL
            charts["pie_chart_url"] = f"images/charts/disability_cause_pie_chart.png"
            print(f"‚úÖ Disability cause pie chart already exists")

        # Check and generate bar chart only if needed
        if self.needs_generation("bar"):
            print(f"üîÑ Generating disability cause bar chart...")
            success, png_path, svg_path = self.chart_generator.generate_chart_image(
                demographic_data=data.get("ward_data", {}),
                output_name="disability_cause_bar_chart",
                static_dir=str(self.static_charts_dir),
                chart_type="bar",
                include_title=False,
            )

            if success and png_path:
                charts["bar_chart_png"] = f"images/charts/{Path(png_path).name}"
                charts["bar_chart_url"] = f"images/charts/{Path(png_path).name}"
                self.mark_generated("bar")
                print(
                    f"‚úÖ Disability cause bar chart generated successfully: {png_path}"
                )
            elif svg_path:
                charts["bar_chart_svg"] = f"images/charts/{Path(svg_path).name}"
                charts["bar_chart_url"] = f"images/charts/{Path(svg_path).name}"
                self.mark_generated("bar")
                print(f"‚úÖ Disability cause bar chart SVG generated: {svg_path}")
        else:
            # Chart already exists, get the URL
            charts["bar_chart_url"] = f"images/charts/disability_cause_bar_chart.png"
            print(f"‚úÖ Disability cause bar chart already exists")

        return charts

    def generate_and_save_charts(self, data):
        """Legacy method - calls new chart management method"""
        return self.generate_and_track_charts(data)

    def process_for_pdf(self):
        """Process disability cause data for PDF generation with simplified chart management"""
        # Get raw data
        data = self.get_data()

        # Generate report content
        report_content = self.generate_report_content(data)

        # Generate charts only if needed
        charts = self.generate_and_track_charts(data)

        # Calculate total population
        total_population = data.get("total_population", 0)

        return {
            "data": data,
            "report_content": report_content,
            "charts": charts,
            "total_population": total_population,
            "section_title": self.get_section_title(),
            "section_number": self.get_section_number(),
        }

    def process_for_template(self):
        """Process disability cause data for template rendering"""
        # Get raw data
        data = self.get_data()

        # Generate report content
        report_content = self.generate_report_content(data)

        # Generate charts
        charts = self.generate_and_track_charts(data)

        return {
            "municipality_data": data.get("municipality_data", {}),
            "ward_data": data.get("ward_data", {}),
            "total_population": data.get("total_population", 0),
            "coherent_analysis": report_content,
            "charts": charts,
        }

    class DisabilityCauseReportFormatter(BaseReportFormatter):
        """Disability cause-specific report formatter"""

        def generate_formal_report(self, disability_data, ward_data, total_population):
            """Generate disability cause formal report content"""

            # Find major disability causes
            major_disabilities = []
            for disability_type, data in disability_data.items():
                if data["population"] > 0:
                    major_disabilities.append(
                        (data["name_nepali"], data["population"], data["percentage"])
                    )

            major_disabilities.sort(key=lambda x: x[1], reverse=True)

            # Build comprehensive analysis
            content = []

            # Introduction
            nepali_total = format_nepali_number(total_population)
            content.append(
                f"""‡§∂‡§∞‡•Ä‡§∞‡§ï‡§æ ‡§Ö‡§ô‡•ç‡§ó‡§π‡§∞‡•Ç ‡§∞ ‡§∂‡§æ‡§∞‡•Ä‡§∞‡§ø‡§ï ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä‡§Æ‡§æ ‡§≠‡§è‡§ï‡•ã ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ‡§ï‡§æ ‡§ï‡§æ‡§∞‡§£ ‡§≠‡•å‡§§‡§ø‡§ï, ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï, ‡§∏‡§æ‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§ø‡§ï ‡§µ‡§æ‡§§‡§æ‡§µ‡§∞‡§£‡§ï‡§æ ‡§∏‡§æ‡§•‡•à ‡§∏‡§û‡•ç‡§ö‡§æ‡§∞ ‡§∏‡§Æ‡•á‡§§‡§¨‡§æ‡§ü ‡§∏‡§ø‡§∞‡•ç‡§ú‡§®‡§æ ‡§≠‡§è‡§ï‡•ã ‡§Ö‡§µ‡§∞‡•ã‡§ß ‡§∏‡§Æ‡•á‡§§‡§≤‡•á ‡§¶‡•à‡§®‡§ø‡§ï ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ‡§ï‡§≤‡§æ‡§™ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∞‡•Ç‡§™‡§Æ‡§æ ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§® ‡§ó‡§∞‡•ç‡§® ‡§è‡§µ‡§Ç ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§ú‡•Ä‡§µ‡§®‡§Æ‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∏‡§π‡§≠‡§æ‡§ó‡•Ä ‡§π‡•Å‡§® ‡§ï‡§†‡§ø‡§®‡§æ‡§à ‡§π‡•Å‡§®‡•á ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ‡§≤‡§æ‡§à ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§≠‡§®‡§ø‡§®‡•ç‡§õ ‡•§ ‡§µ‡§ø‡§∂‡•á‡§∑‡§ó‡§∞‡•Ä ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§π‡§∞‡•Ç‡§Æ‡§æ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§π‡•Å‡§®‡•á ‡§ï‡§æ‡§∞‡§£ ‡§ú‡§®‡•ç‡§Æ‡§ú‡§æ‡§§, ‡§¶‡•Å‡§∞‡•ç‡§ò‡§ü‡§®‡§æ, ‡§∞‡•ã‡§ó‡§ï‡•ã ‡§ï‡§æ‡§∞‡§£, ‡§¶‡•ç‡§µ‡§®‡•ç‡§¶‡•ç‡§µ‡§ï‡•ã ‡§ï‡§æ‡§∞‡§£, ‡§ï‡•Å‡§™‡•ã‡§∑‡§£ ‡§Ü‡§¶‡§ø ‡§¶‡•á‡§ñ‡§ø‡§è‡§ï‡§æ ‡§õ‡§®‡•ç ‡•§ ‡§ú‡§∏‡§≤‡§æ‡§à ‡§ò‡§ü‡§æ‡§â‡§® ‡§™‡•ç‡§∞‡§§‡§ø‡§∞‡•ã‡§ß‡§æ‡§§‡•ç‡§Æ‡§ï ‡§∞ ‡§â‡§™‡§ö‡§æ‡§∞‡§æ‡§§‡•ç‡§Æ‡§ï ‡§¶‡•Å‡§µ‡•à ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§π‡§∞‡•Ç ‡§ó‡§∞‡§ø‡§®‡•Å‡§™‡§∞‡•ç‡§¶‡§õ ‡•§ ‡§ó‡§æ‡§â‡§Å‡§™‡§æ‡§≤‡§ø‡§ï‡§æ‡§≤‡•á ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§∏‡§û‡•ç‡§ú‡§æ‡§≤ ‡§ó‡§†‡§® ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡§ø‡§ï‡§æ ‡•®‡•¶‡•≠‡•Æ, ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§≠‡§è‡§ï‡§æ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ï‡•ã ‡§™‡§∞‡§ø‡§ö‡§Ø ‡§™‡§§‡•ç‡§∞ ‡§µ‡§ø‡§§‡§∞‡§£ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§ø‡§ß‡§ø ‡§§‡§Ø‡§æ‡§∞ ‡§ó‡§∞‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§®‡•ç‡§µ‡§Ø‡§®‡§Æ‡§æ ‡§≤‡•ç‡§Ø‡§æ‡§è‡§ï‡•ã ‡§õ ‡•§"""
            )

            # Top disability causes analysis
            if len(major_disabilities) >= 3:
                top_three = major_disabilities[:3]
                first_dis = top_three[0]
                second_dis = top_three[1]
                third_dis = top_three[2]

                first_pop = format_nepali_number(first_dis[1])
                first_pct = format_nepali_percentage(first_dis[2])
                second_pop = format_nepali_number(second_dis[1])
                second_pct = format_nepali_percentage(second_dis[2])
                third_pop = format_nepali_number(third_dis[1])
                third_pct = format_nepali_percentage(third_dis[2])

                content.append(
                    f"""‡§ò‡§∞‡§ß‡•Å‡§∞‡•Ä ‡§§‡§•‡•ç‡§Ø‡§æ‡§ô‡•ç‡§ï ‡§∏‡§Ç‡§ï‡§≤‡§®, ‡•®‡•¶‡•Æ‡•ß ‡§ï‡•ã ‡§§‡§•‡•ç‡§Ø‡§æ‡§ô‡•ç‡§ï ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§ó‡§æ‡§â‡§Å‡§™‡§æ‡§≤‡§ø‡§ï‡§æ‡§Æ‡§æ ‡§∞‡§π‡•á‡§ï‡•ã ‡§ï‡•Ç‡§≤ {nepali_total} ‡§ú‡§®‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§∏‡§¨‡•à‡§≠‡§®‡•ç‡§¶‡§æ ‡§¨‡§¢‡•Ä {first_pop} ‡§ú‡§®‡§æ ‡§Ö‡§∞‡•ç‡§•‡§æ‡§§ {first_pct} ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§ {first_dis[0]} ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§∞‡§π‡•á‡§ï‡§æ ‡§õ‡§®‡•ç ‡§≠‡§®‡•á ‡§¶‡•ã‡§∏‡•ç‡§∞‡•ã‡§Æ‡§æ {second_pop} ‡§ú‡§®‡§æ ‡§Ö‡§∞‡•ç‡§•‡§æ‡§§ {second_pct} ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§ {second_dis[0]} ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§∞ ‡§§‡•á‡§∏‡•ç‡§∞‡•ã‡§Æ‡§æ {third_pop} ‡§ú‡§®‡§æ ‡§Ö‡§∞‡•ç‡§•‡§æ‡§§ {third_pct} ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§ {third_dis[0]} ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§∞‡§π‡•á‡§ï‡§æ ‡§õ‡§®‡•ç ‡•§"""
                )

            # Congenital disability analysis
            congenital_data = next(
                (dis for dis in major_disabilities if "‡§ú‡§®‡•ç‡§Æ‡§ú‡§æ‡§§" in dis[0]), None
            )
            if congenital_data:
                congenital_pop = format_nepali_number(congenital_data[1])
                congenital_pct = format_nepali_percentage(congenital_data[2])
                content.append(
                    f"""‡§ú‡§®‡•ç‡§Æ‡§ú‡§æ‡§§ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ‡§Æ‡§æ {congenital_pop} ‡§ú‡§®‡§æ ({congenital_pct} ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§) ‡§∞‡§π‡•á‡§ï‡•ã ‡§¶‡•á‡§ñ‡§ø‡§®‡•ç‡§õ ‡§ú‡§∏‡§≤‡•á ‡§ó‡§∞‡•ç‡§≠‡§æ‡§µ‡§∏‡•ç‡§•‡§æ‡§ï‡•ã ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•á‡§µ‡§æ ‡§∞ ‡§ú‡§®‡•ç‡§Æ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤‡§ï‡•ã ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£‡§§‡§æ ‡§¶‡•á‡§ñ‡§æ‡§â‡§Å‡§õ ‡•§"""
                )

            # Accident-related disability
            accident_data = next(
                (dis for dis in major_disabilities if "‡§¶‡•Å‡§∞‡•ç‡§ò‡§ü‡§®‡§æ" in dis[0]), None
            )
            if accident_data:
                accident_pop = format_nepali_number(accident_data[1])
                accident_pct = format_nepali_percentage(accident_data[2])
                content.append(
                    f"""‡§¶‡•Å‡§∞‡•ç‡§ò‡§ü‡§®‡§æ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ‡§Æ‡§æ {accident_pop} ‡§ú‡§®‡§æ ({accident_pct} ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§) ‡§∞‡§π‡•á‡§ï‡§æ ‡§õ‡§®‡•ç ‡§ú‡§∏‡§≤‡•á ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ú‡§æ‡§ó‡§∞‡•Ç‡§ï‡§§‡§æ ‡§∞ ‡§¶‡•Å‡§∞‡•ç‡§ò‡§ü‡§®‡§æ ‡§®‡§ø‡§µ‡§æ‡§∞‡§£‡§ï‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ‡§π‡§∞‡•Ç‡§ï‡•ã ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§¶‡•á‡§ñ‡§æ‡§â‡§Å‡§õ ‡•§"""
                )

            # Disease-related disability
            disease_data = next(
                (dis for dis in major_disabilities if "‡§∞‡•ã‡§ó‡§ï‡•ã ‡§ï‡§æ‡§∞‡§£" in dis[0]), None
            )
            if disease_data:
                disease_pop = format_nepali_number(disease_data[1])
                disease_pct = format_nepali_percentage(disease_data[2])
                content.append(
                    f"""‡§∞‡•ã‡§ó‡§ï‡•ã ‡§ï‡§æ‡§∞‡§£ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ‡§Æ‡§æ {disease_pop} ‡§ú‡§®‡§æ ({disease_pct} ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§) ‡§∞‡§π‡•á‡§ï‡§æ ‡§õ‡§®‡•ç ‡§ú‡§∏‡§≤‡•á ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•á‡§µ‡§æ ‡§∞ ‡§∞‡•ã‡§ó ‡§®‡§ø‡§µ‡§æ‡§∞‡§£‡§ï‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ‡§π‡§∞‡•Ç‡§ï‡•ã ‡§Æ‡§π‡§§‡•ç‡§µ ‡§¶‡•á‡§ñ‡§æ‡§â‡§Å‡§õ ‡•§"""
                )

            # Malnutrition-related disability
            malnutrition_data = next(
                (dis for dis in major_disabilities if "‡§ï‡•Å‡§™‡•ã‡§∑‡§£" in dis[0]), None
            )
            if malnutrition_data:
                malnutrition_pop = format_nepali_number(malnutrition_data[1])
                malnutrition_pct = format_nepali_percentage(malnutrition_data[2])
                content.append(
                    f"""‡§ï‡•Å‡§™‡•ã‡§∑‡§£‡§ï‡§æ ‡§ï‡§æ‡§∞‡§£ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ‡§Æ‡§æ {malnutrition_pop} ‡§ú‡§®‡§æ ({malnutrition_pct} ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§) ‡§∞‡§π‡•á‡§ï‡§æ ‡§õ‡§®‡•ç ‡§ú‡§∏‡§≤‡•á ‡§™‡•ã‡§∑‡§£ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∞ ‡§ñ‡§æ‡§®‡§™‡§æ‡§® ‡§ú‡§æ‡§ó‡§∞‡•Ç‡§ï‡§§‡§æ‡§ï‡•ã ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§¶‡•á‡§ñ‡§æ‡§â‡§Å‡§õ ‡•§"""
                )

            # Conflict-related disability
            conflict_data = next(
                (dis for dis in major_disabilities if "‡§¶‡•ç‡§µ‡§®‡•ç‡§¶‡•ç‡§µ‡§ï‡•ã ‡§ï‡§æ‡§∞‡§£" in dis[0]), None
            )
            if conflict_data:
                conflict_pop = format_nepali_number(conflict_data[1])
                conflict_pct = format_nepali_percentage(conflict_data[2])
                content.append(
                    f"""‡§¶‡•ç‡§µ‡§®‡•ç‡§¶‡•ç‡§µ‡§ï‡•ã ‡§ï‡§æ‡§∞‡§£ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ‡§Æ‡§æ {conflict_pop} ‡§ú‡§®‡§æ ({conflict_pct} ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§) ‡§∞‡§π‡•á‡§ï‡§æ ‡§õ‡§®‡•ç ‡§ú‡§∏‡§≤‡•á ‡§∂‡§æ‡§®‡•ç‡§§‡§ø ‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ‡§ï‡•ã ‡§Æ‡§π‡§§‡•ç‡§µ ‡§¶‡•á‡§ñ‡§æ‡§â‡§Å‡§õ ‡•§"""
                )

            # Other causes
            other_data = next(
                (dis for dis in major_disabilities if "‡§Ö‡§®‡•ç‡§Ø" in dis[0]), None
            )
            if other_data:
                other_pop = format_nepali_number(other_data[1])
                other_pct = format_nepali_percentage(other_data[2])
                content.append(
                    f"""‡§Ö‡§®‡•ç‡§Ø ‡§ï‡§æ‡§∞‡§£‡§π‡§∞‡•Ç‡§¨‡§æ‡§ü ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ‡§Æ‡§æ {other_pop} ‡§ú‡§®‡§æ ({other_pct} ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§) ‡§∞‡§π‡•á‡§ï‡§æ ‡§õ‡§®‡•ç ‡•§"""
                )

            # Prevention and intervention strategies
            content.append(
                """‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§®‡§ø‡§µ‡§æ‡§∞‡§£ ‡§∞ ‡§π‡§∏‡•ç‡§§‡§ï‡•ç‡§∑‡•á‡§™‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§ó‡§æ‡§â‡§Å‡§™‡§æ‡§≤‡§ø‡§ï‡§æ‡§≤‡•á ‡§µ‡§ø‡§≠‡§ø‡§®‡•ç‡§® ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ‡§π‡§∞‡•Ç ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§® ‡§ó‡§∞‡•á‡§ï‡•ã ‡§õ ‡•§ ‡§ú‡§®‡•ç‡§Æ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤, ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ú‡§®‡•ç‡§Æ, ‡§¨‡§æ‡§≤ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ, ‡§∞‡•ã‡§ó ‡§®‡§ø‡§µ‡§æ‡§∞‡§£ ‡§∞ ‡§â‡§™‡§ö‡§æ‡§∞, ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ú‡§æ‡§ó‡§∞‡•Ç‡§ï‡§§‡§æ ‡§∞ ‡§™‡•ã‡§∑‡§£ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ‡§π‡§∞‡•Ç ‡§Æ‡§æ‡§∞‡•ç‡§´‡§§ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§®‡§ø‡§µ‡§æ‡§∞‡§£ ‡§ó‡§∞‡•ç‡§®‡•á ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ ‡•§"""
            )

            # Social inclusion and support
            content.append(
                """‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§≠‡§è‡§ï‡§æ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§π‡§∞‡•Ç‡§ï‡•ã ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§∏‡§Æ‡§æ‡§µ‡•á‡§∂‡•Ä‡§ï‡§∞‡§£ ‡§∞ ‡§∏‡§π‡§Ø‡•ã‡§ó‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ, ‡§µ‡•ç‡§Ø‡§æ‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§§‡§æ‡§≤‡§ø‡§Æ, ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä‡§ï‡•ã ‡§Ö‡§µ‡§∏‡§∞ ‡§∞ ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ‡§π‡§∞‡•Ç ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§® ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ ‡•§ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§≠‡§è‡§ï‡§æ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§π‡§∞‡•Ç‡§≤‡§æ‡§à ‡§∏‡§Æ‡§æ‡§® ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§∞ ‡§Ö‡§µ‡§∏‡§∞ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ó‡§∞‡•ç‡§®‡•á ‡§®‡•Ä‡§§‡§ø ‡§Ö‡§™‡§®‡§æ‡§á‡§è‡§ï‡•ã ‡§õ ‡•§"""
            )

            # Infrastructure and accessibility
            content.append(
                """‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§≠‡§è‡§ï‡§æ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§π‡§∞‡•Ç‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§∏‡•Å‡§≤‡§≠ ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞ ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£ ‡§∞ ‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ó‡§∞‡•ç‡§®‡•á ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ ‡•§ ‡§∏‡§°‡§ï, ‡§≠‡§µ‡§®, ‡§∂‡•à‡§ï‡•ç‡§∑‡§ø‡§ï ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ ‡§∞ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•á‡§µ‡§æ ‡§ï‡•á‡§®‡•ç‡§¶‡•ç‡§∞‡§π‡§∞‡•Ç‡§Æ‡§æ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§Æ‡•à‡§§‡•ç‡§∞‡•Ä ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ‡§π‡§∞‡•Ç ‡§•‡§™ ‡§ó‡§∞‡•ç‡§®‡•á ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∞‡§π‡•á‡§ï‡•ã ‡§õ ‡•§"""
            )

            # Ward-wise analysis
            content.append(
                """‡§µ‡§°‡§æ‡§ó‡§§ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£‡§≤‡•á ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ‡§ï‡§æ ‡§ï‡§æ‡§∞‡§£‡§π‡§∞‡•Ç‡§ï‡•ã ‡§≠‡•å‡§ó‡•ã‡§≤‡§ø‡§ï ‡§µ‡§ø‡§µ‡§ø‡§ß‡§§‡§æ ‡§¶‡•á‡§ñ‡§æ‡§â‡§Å‡§õ ‡•§ ‡§ï‡•Å‡§®‡•à ‡§µ‡§°‡§æ‡§Æ‡§æ ‡§¶‡•Å‡§∞‡•ç‡§ò‡§ü‡§®‡§æ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§¨‡§¢‡•Ä ‡§≠‡§®‡•á ‡§ï‡•Å‡§®‡•à‡§Æ‡§æ ‡§ú‡§®‡•ç‡§Æ‡§ú‡§æ‡§§ ‡§µ‡§æ ‡§∞‡•ã‡§ó‡§ï‡•ã ‡§ï‡§æ‡§∞‡§£ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§¨‡§¢‡•Ä ‡§∞‡§π‡•á‡§ï‡•ã ‡§õ ‡•§ ‡§Ø‡§∏‡§≤‡•á ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§∏‡•ç‡§§‡§∞‡§Æ‡§æ ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ‡§π‡§∞‡•Ç‡§ï‡•ã ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§¶‡•á‡§ñ‡§æ‡§â‡§Å‡§õ ‡•§"""
            )

            # Future prospects and challenges
            content.append(
                """‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§Æ‡§æ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§®‡§ø‡§µ‡§æ‡§∞‡§£ ‡§∞ ‡§™‡•Å‡§®‡§∞‡•ç‡§∏‡•ç‡§•‡§æ‡§™‡§®‡§ï‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ‡§π‡§∞‡•Ç ‡§•‡§™ ‡§µ‡§ø‡§∏‡•ç‡§§‡§æ‡§∞ ‡§ó‡§∞‡•ç‡§®‡•á ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∞‡§π‡•á‡§ï‡•ã ‡§õ ‡•§ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§≠‡§è‡§ï‡§æ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§π‡§∞‡•Ç‡§ï‡•ã ‡§∏‡§∂‡§ï‡•ç‡§§‡§ø‡§ï‡§∞‡§£ ‡§∞ ‡§∏‡•ç‡§µ‡§æ‡§µ‡§≤‡§Æ‡•ç‡§¨‡§®‡§ï‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ‡§π‡§∞‡•Ç ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§® ‡§ó‡§∞‡•Ä ‡§§‡§ø‡§®‡§≤‡§æ‡§à ‡§∏‡§Æ‡§æ‡§ú‡§ï‡•ã ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ß‡§æ‡§∞‡§æ‡§Æ‡§æ ‡§≤‡•ç‡§Ø‡§æ‡§â‡§®‡•á ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ó‡§∞‡§ø‡§®‡•á‡§õ ‡•§"""
            )

            # Policy and legal framework
            content.append(
                """‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§≠‡§è‡§ï‡§æ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§π‡§∞‡•Ç‡§ï‡•ã ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä ‡§¢‡§æ‡§Å‡§ö‡§æ ‡§∞ ‡§®‡•Ä‡§§‡§ø‡§π‡§∞‡•Ç ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§®‡•ç‡§µ‡§Ø‡§® ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ ‡•§ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§∏‡§û‡•ç‡§ú‡§æ‡§≤ ‡§ó‡§†‡§® ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡§ø‡§ï‡§æ ‡•®‡•¶‡•≠‡•Æ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§Ö‡§™‡§æ‡§ô‡•ç‡§ó‡§§‡§æ ‡§≠‡§è‡§ï‡§æ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ï‡•ã ‡§™‡§∞‡§ø‡§ö‡§Ø ‡§™‡§§‡•ç‡§∞ ‡§µ‡§ø‡§§‡§∞‡§£ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§ø‡§ß‡§ø ‡§§‡§Ø‡§æ‡§∞ ‡§ó‡§∞‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§®‡•ç‡§µ‡§Ø‡§®‡§Æ‡§æ ‡§≤‡•ç‡§Ø‡§æ‡§è‡§ï‡•ã ‡§õ ‡•§"""
            )

            return " ".join(content)
